{
  "id": "snapshot_1767932636010_lf125i9wm",
  "approvalId": "approval_1767932636008_qjdbvj6w9",
  "approvalTitle": "Design Document - ScribeVault Architecture",
  "version": 1,
  "timestamp": "2026-01-09T04:23:56.009Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document: ScribeVault\n\n## Overview\n\nScribeVault is a zero-knowledge HIPAA-compliant web application built with Next.js (Pages Router), TypeScript, Tailwind CSS, and shadcn/ui. The architecture implements a stateless backend that acts as a pure transit pipe to Groq AI APIs, while all Protected Health Information (PHI) is encrypted client-side using Web Crypto API with keys derived from user-defined PINs. The design prioritizes security through encryption, session management, and aggressive data lifecycle policies.\n\n**Core Architectural Principles:**\n- Zero-knowledge: Server never has access to unencrypted PHI\n- Stateless processing: No server-side data persistence\n- Client-side encryption: All PHI encrypted at rest in IndexedDB\n- Session security: Aggressive timeouts and brute force protection\n\n## Steering Document Alignment\n\n### Technical Standards\n\nSince no steering documents exist yet, this design establishes the following technical standards:\n\n- **Framework**: Next.js 16.x with Pages Router (explicit requirement - NOT App Router)\n- **Language**: TypeScript with strict mode enabled\n- **Styling**: Tailwind CSS v4 + shadcn/ui component library\n- **Authentication**: Firebase Auth (client SDK) + Firebase Admin (server SDK)\n- **AI/ML**: Groq SDK for Whisper Turbo (transcription) and Llama 3.3 70B (SOAP formatting)\n- **Storage**: IndexedDB via idb-keyval (lightweight wrapper)\n- **Cryptography**: Web Crypto API (browser native, FIPS compliant)\n\n### Project Structure\n\nFollowing Next.js Pages Router conventions with organized module boundaries:\n\n```\nsrc/\n├── pages/              # Next.js Pages Router\n│   ├── _app.tsx        # App wrapper with providers\n│   ├── _document.tsx   # Custom document\n│   ├── index.tsx       # Main application\n│   ├── login.tsx       # Authentication page\n│   └── api/            # API routes (serverless functions)\n│       ├── auth/\n│       │   └── init.ts\n│       └── scribe.ts\n├── components/         # React UI components\n├── context/            # React Context providers\n├── hooks/              # Custom React hooks\n├── lib/                # Library initialization and utilities\n├── types/              # TypeScript type definitions\n└── styles/             # Global styles\n```\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\nThis is a fresh Next.js application, so we'll leverage external libraries:\n\n- **Next.js**: Routing, API routes, SSR capabilities, build optimization\n- **shadcn/ui**: Pre-built accessible components (Button, Card, Input, Dialog, Alert, Toast, Sonner)\n- **Tailwind CSS**: Utility-first styling with responsive design\n- **Firebase SDK**: Authentication, token management, custom claims\n- **Groq SDK**: AI/ML API client for transcription and text generation\n- **idb-keyval**: Simple IndexedDB wrapper (reduces boilerplate vs raw IndexedDB API)\n- **Web Crypto API**: Browser-native cryptography (no external crypto library needed)\n\n### Integration Points\n\n- **Firebase Identity Platform**: User authentication and JWT token generation\n- **Groq Cloud**: External AI API for Whisper (STT) and Llama (text generation)\n- **IndexedDB**: Browser storage for encrypted notes\n- **Browser APIs**: MediaRecorder, Wake Lock, Web Crypto\n\n## Architecture\n\n### High-Level Architecture\n\n```mermaid\ngraph TB\n    subgraph \"Client (Browser)\"\n        UI[React UI Components]\n        AC[AuthContext]\n        VC[VaultContext]\n        IDB[(IndexedDB<br/>Encrypted Notes)]\n        WC[Web Crypto API]\n\n        UI --> AC\n        UI --> VC\n        VC --> WC\n        VC --> IDB\n    end\n\n    subgraph \"Next.js API Routes\"\n        AuthAPI[/api/auth/init]\n        ScribeAPI[/api/scribe]\n\n        AuthAPI --> FA[Firebase Admin]\n        ScribeAPI --> FA\n        ScribeAPI --> Groq[Groq SDK]\n    end\n\n    subgraph \"External Services\"\n        FB[Firebase Auth]\n        GROQ[Groq Cloud APIs]\n    end\n\n    UI -->|Login/Logout| FB\n    AC -->|Token Refresh| FB\n    AuthAPI -->|Custom Claims| FB\n\n    UI -->|Audio Upload| ScribeAPI\n    Groq -->|Transcribe| GROQ\n    Groq -->|SOAP Format| GROQ\n\n    style IDB fill:#e1f5fe\n    style WC fill:#f3e5f5\n    style GROQ fill:#fff3e0\n    style FB fill:#fff3e0\n```\n\n### Security Architecture\n\n```mermaid\ngraph LR\n    PIN[User PIN<br/>6-8 digits] --> PBKDF2[PBKDF2<br/>250k iterations<br/>SHA-256]\n    VS[Vault Secret<br/>32-byte hex<br/>from Firebase] --> PBKDF2\n    PBKDF2 --> VK[Vault Key<br/>AES-GCM 256-bit<br/>non-extractable]\n\n    VK --> ENC[Encrypt Note]\n    VK --> DEC[Decrypt Note]\n\n    NOTE[Plain Note] --> ENC\n    IV[Random IV<br/>12 bytes] --> ENC\n    ENC --> CIPHER[Encrypted Note<br/>Base64]\n    CIPHER --> IDB[(IndexedDB)]\n\n    IDB --> CIPHER2[Encrypted Note]\n    IV2[Stored IV] --> DEC\n    CIPHER2 --> DEC\n    DEC --> NOTE2[Plain Note]\n\n    style PIN fill:#ffebee\n    style VS fill:#e8f5e9\n    style VK fill:#fff3e0\n    style IDB fill:#e1f5fe\n```\n\n### Modular Design Principles\n\n- **Single File Responsibility**:\n  - `crypto.ts` handles only cryptographic operations\n  - `storage.ts` handles only IndexedDB operations\n  - `firebase-client.ts` handles only client-side Firebase init\n  - `firebase-admin.ts` handles only server-side Firebase init\n  - `groq.ts` handles only Groq client init\n\n- **Component Isolation**:\n  - Each UI component (PINOverlay, Recorder, NoteCard) is self-contained\n  - Components receive props and callbacks, not global state directly\n  - Contexts manage global state, components consume it\n\n- **Service Layer Separation**:\n  - API routes (`/api/*`) handle server-side logic\n  - Hooks (`useRecorder`, `useNotes`) handle client-side business logic\n  - Components handle only presentation\n\n- **Utility Modularity**:\n  - Crypto utilities are pure functions (no side effects)\n  - Storage utilities abstract IndexedDB complexity\n  - Constants are centralized in `constants.ts`\n\n## Components and Interfaces\n\n### 1. Authentication System\n\n#### `src/lib/firebase-client.ts`\n- **Purpose:** Initialize Firebase client SDK for browser authentication\n- **Interfaces:**\n  - `export const auth: Auth` - Firebase Auth instance\n  - `export const googleProvider: GoogleAuthProvider` - Google sign-in provider\n  - `export const emailPasswordProvider: EmailAuthProvider` - Email/password provider\n- **Dependencies:** firebase package\n- **Reuses:** Firebase SDK initialization patterns\n\n#### `src/lib/firebase-admin.ts`\n- **Purpose:** Initialize Firebase Admin SDK for server-side token verification\n- **Interfaces:**\n  - `export const adminAuth: Auth` - Firebase Admin Auth instance\n- **Dependencies:** firebase-admin package, FIREBASE_SERVICE_ACCOUNT_JSON env var\n- **Reuses:** Firebase Admin SDK patterns\n\n#### `src/context/AuthContext.tsx`\n- **Purpose:** Manage authentication state and provide auth operations to components\n- **Interfaces:**\n  ```typescript\n  interface AuthContextValue {\n    user: User | null;\n    loading: boolean;\n    idToken: string | null;\n    vaultSecret: string | null;\n    signInWithGoogle: () => Promise<void>;\n    signInWithEmail: (email: string, password: string) => Promise<void>;\n    signOut: () => Promise<void>;\n  }\n  ```\n- **Dependencies:** Firebase client SDK, jwt-decode (for extracting custom claims)\n- **Reuses:** React Context API, Firebase Auth state observer\n\n#### `src/pages/api/auth/init.ts`\n- **Purpose:** Initialize vault secret as Firebase custom claim on first login\n- **Interfaces:**\n  - POST `/api/auth/init`\n  - Request: `{ idToken: string }`\n  - Response: `{ status: 'ready' | 'created' }`\n- **Dependencies:** Firebase Admin SDK, crypto.randomBytes\n- **Reuses:** Next.js API route pattern\n\n### 2. Encryption System\n\n#### `src/lib/constants.ts`\n- **Purpose:** Centralize all configuration constants\n- **Interfaces:**\n  ```typescript\n  export const CRYPTO_CONFIG: {\n    PBKDF2_ITERATIONS: 250000,\n    KEY_LENGTH: 256,\n    IV_LENGTH: 12,\n    SALT_ALGORITHM: 'SHA-256',\n  };\n\n  export const SESSION_CONFIG: {\n    IDLE_TIMEOUT_MS: 900000, // 15 min\n    MAX_RECORDING_MS: 3600000, // 60 min\n    DATA_TTL_MS: 43200000, // 12 hours\n    JANITOR_INTERVAL_MS: 300000, // 5 min\n    MAX_PIN_ATTEMPTS: 5,\n  };\n\n  export const PIN_CONFIG: {\n    MIN_LENGTH: 6,\n    MAX_LENGTH: 8,\n  };\n  ```\n- **Dependencies:** None\n- **Reuses:** TypeScript const assertions\n\n#### `src/types/index.ts`\n- **Purpose:** Define all TypeScript interfaces and types\n- **Interfaces:**\n  ```typescript\n  export interface EncryptedNote {\n    id: string;\n    timestamp: number;\n    iv: string; // Base64 encoded\n    data: string; // Base64 encoded ciphertext\n  }\n\n  export interface DecryptedNote {\n    id: string;\n    timestamp: number;\n    transcript: string;\n    soapNote: string;\n    duration: number;\n  }\n\n  export interface VaultState {\n    isUnlocked: boolean;\n    isFirstTime: boolean;\n    pinAttemptsRemaining: number;\n  }\n\n  export type RecordingStatus = 'idle' | 'recording' | 'processing' | 'complete' | 'error';\n  ```\n- **Dependencies:** None\n- **Reuses:** TypeScript type system\n\n#### `src/lib/crypto.ts`\n- **Purpose:** Provide cryptographic operations using Web Crypto API\n- **Interfaces:**\n  ```typescript\n  export async function deriveVaultKey(pin: string, vaultSecret: string): Promise<CryptoKey>;\n  export async function encryptData(key: CryptoKey, data: string): Promise<{ iv: string; ciphertext: string }>;\n  export async function decryptData(key: CryptoKey, iv: string, ciphertext: string): Promise<string>;\n  export function isValidPIN(pin: string): boolean;\n  ```\n- **Dependencies:** Web Crypto API (browser native)\n- **Reuses:** PBKDF2 and AES-GCM algorithms (FIPS 140-2 compliant)\n\n#### `src/lib/storage.ts`\n- **Purpose:** Manage encrypted note storage in IndexedDB\n- **Interfaces:**\n  ```typescript\n  export async function saveEncryptedNote(key: CryptoKey, note: DecryptedNote): Promise<void>;\n  export async function loadAllNotes(key: CryptoKey): Promise<DecryptedNote[]>;\n  export async function deleteNote(noteId: string): Promise<void>;\n  export async function purgeAllData(): Promise<void>;\n  export async function runJanitor(): Promise<number>;\n  ```\n- **Dependencies:** idb-keyval, crypto.ts\n- **Reuses:** idb-keyval's get/set API\n\n#### `src/context/VaultContext.tsx`\n- **Purpose:** Manage vault key state, PIN operations, and session management\n- **Interfaces:**\n  ```typescript\n  interface VaultContextValue {\n    vaultKey: CryptoKey | null;\n    isLocked: boolean;\n    isFirstTimeSetup: boolean;\n    pinAttemptsRemaining: number;\n    recordingStatus: RecordingStatus;\n    unlock: (pin: string) => Promise<boolean>;\n    lock: () => void;\n    setupPIN: (pin: string) => Promise<void>;\n    setRecordingStatus: (status: RecordingStatus) => void;\n    resetBruteForce: () => void;\n  }\n  ```\n- **Dependencies:** AuthContext, crypto.ts, storage.ts\n- **Reuses:** React Context, useEffect for idle timer and janitor\n\n### 3. Recording System\n\n#### `src/hooks/useRecorder.ts`\n- **Purpose:** Manage audio recording using MediaRecorder API\n- **Interfaces:**\n  ```typescript\n  interface UseRecorderReturn {\n    status: RecordingStatus;\n    duration: number;\n    remainingTime: number;\n    startRecording: () => Promise<void>;\n    stopRecording: () => Promise<Blob>;\n    error: string | null;\n  }\n  ```\n- **Dependencies:** MediaRecorder API, Wake Lock API (optional)\n- **Reuses:** React hooks (useState, useEffect, useRef)\n\n#### `src/components/Recorder.tsx`\n- **Purpose:** UI for audio recording with visual feedback\n- **Interfaces:**\n  - Props: `{ onRecordingComplete: (blob: Blob, duration: number) => void }`\n- **Dependencies:** useRecorder hook, VaultContext\n- **Reuses:** shadcn/ui Button, visual feedback patterns\n\n#### `src/lib/groq.ts`\n- **Purpose:** Initialize Groq SDK client\n- **Interfaces:**\n  ```typescript\n  export const groq: Groq;\n  export const SOAP_SYSTEM_PROMPT: string;\n  ```\n- **Dependencies:** groq-sdk package, GROQ_API_KEY env var\n- **Reuses:** Groq SDK initialization\n\n#### `src/pages/api/scribe.ts`\n- **Purpose:** Proxy API for transcription and SOAP note generation\n- **Interfaces:**\n  - POST `/api/scribe`\n  - Request: `multipart/form-data { audio: File, idToken: string }`\n  - Response: `{ transcript: string, soapNote: string }`\n- **Dependencies:** Firebase Admin, Groq SDK, multipart form parser\n- **Reuses:** Next.js API route, Groq Whisper and Llama models\n\n### 4. Notes Management\n\n#### `src/hooks/useNotes.ts`\n- **Purpose:** Manage notes CRUD operations\n- **Interfaces:**\n  ```typescript\n  interface UseNotesReturn {\n    notes: DecryptedNote[];\n    loading: boolean;\n    loadNotes: () => Promise<void>;\n    saveNote: (note: DecryptedNote) => Promise<void>;\n    deleteNote: (noteId: string) => Promise<void>;\n    error: string | null;\n  }\n  ```\n- **Dependencies:** VaultContext, storage.ts\n- **Reuses:** React hooks\n\n#### `src/components/NoteCard.tsx`\n- **Purpose:** Display individual note with expand/collapse and actions\n- **Interfaces:**\n  - Props: `{ note: DecryptedNote, onDelete: (id: string) => void }`\n- **Dependencies:** None (presentational component)\n- **Reuses:** shadcn/ui Card, Button, Dialog\n\n#### `src/components/NotesList.tsx`\n- **Purpose:** Display list of notes\n- **Interfaces:**\n  - Props: `{ notes: DecryptedNote[], onDelete: (id: string) => void }`\n- **Dependencies:** NoteCard component\n- **Reuses:** Array mapping pattern\n\n### 5. Session Management\n\n#### `src/hooks/useIdleTimer.ts`\n- **Purpose:** Detect user inactivity and trigger vault lock\n- **Interfaces:**\n  ```typescript\n  interface UseIdleTimerReturn {\n    timeUntilLock: number; // milliseconds\n    resetTimer: () => void;\n  }\n  ```\n- **Dependencies:** VaultContext\n- **Reuses:** Event listeners (mousedown, keydown, scroll, touchstart)\n\n#### `src/components/SessionTimer.tsx`\n- **Purpose:** Display countdown to session lock\n- **Interfaces:**\n  - Props: `{ timeUntilLock: number }`\n- **Dependencies:** useIdleTimer hook\n- **Reuses:** shadcn/ui visual feedback components\n\n### 6. PIN Management UI\n\n#### `src/components/PINOverlay.tsx`\n- **Purpose:** Full-screen PIN entry overlay for unlocking vault\n- **Interfaces:**\n  - Props: `{ onUnlock: (pin: string) => Promise<boolean>, attemptsRemaining: number }`\n- **Dependencies:** VaultContext\n- **Reuses:** shadcn/ui Input, Button, Card\n\n#### `src/components/PINSetup.tsx`\n- **Purpose:** First-time PIN creation flow\n- **Interfaces:**\n  - Props: `{ onSetup: (pin: string) => Promise<void> }`\n- **Dependencies:** VaultContext\n- **Reuses:** shadcn/ui Input, Button, Card\n\n### 7. Layout and Pages\n\n#### `src/components/Layout.tsx`\n- **Purpose:** Main layout wrapper with header and navigation\n- **Interfaces:**\n  - Props: `{ children: ReactNode }`\n- **Dependencies:** AuthContext\n- **Reuses:** shadcn/ui layout patterns\n\n#### `src/pages/login.tsx`\n- **Purpose:** Authentication page\n- **Interfaces:** Standard Next.js page\n- **Dependencies:** AuthContext, Firebase client\n- **Reuses:** shadcn/ui Button, Card\n\n#### `src/pages/index.tsx`\n- **Purpose:** Main application page with recorder and notes list\n- **Interfaces:** Standard Next.js page\n- **Dependencies:** All contexts, Recorder, NotesList\n- **Reuses:** Layout component\n\n#### `src/pages/_app.tsx`\n- **Purpose:** App wrapper with providers\n- **Interfaces:** Standard Next.js App component\n- **Dependencies:** AuthContext, VaultContext\n- **Reuses:** Next.js App component pattern\n\n## Data Models\n\n### EncryptedNote (IndexedDB Storage Model)\n```typescript\n{\n  id: string;              // UUID v4\n  timestamp: number;       // Unix timestamp (ms) when note was created\n  iv: string;              // Base64-encoded 12-byte initialization vector\n  data: string;            // Base64-encoded AES-GCM ciphertext\n}\n```\n\n**Storage Format:**\n- Stored in IndexedDB under key: `'clinical_notes'`\n- Value is an array: `EncryptedNote[]`\n- No indexes (simple key-value storage via idb-keyval)\n\n### DecryptedNote (Application Model)\n```typescript\n{\n  id: string;              // UUID v4 (matches EncryptedNote.id)\n  timestamp: number;       // Unix timestamp (ms)\n  transcript: string;      // Raw transcript from Groq Whisper\n  soapNote: string;        // Formatted SOAP note from Groq Llama\n  duration: number;        // Recording duration in seconds\n}\n```\n\n**Serialization:**\n- Serialized to JSON before encryption\n- Deserialized from JSON after decryption\n\n### VaultKey (In-Memory Only)\n```typescript\nCryptoKey {\n  type: 'secret',\n  algorithm: { name: 'AES-GCM', length: 256 },\n  extractable: false,      // CRITICAL: prevents key extraction\n  usages: ['encrypt', 'decrypt']\n}\n```\n\n**Derivation:**\n- Derived using PBKDF2 with:\n  - Password: User PIN (6-8 digits, UTF-8 encoded)\n  - Salt: Vault Secret (32-byte hex from Firebase custom claim, UTF-8 encoded)\n  - Iterations: 250,000\n  - Hash: SHA-256\n  - Output: 256-bit AES-GCM key\n\n**Lifecycle:**\n- Created: On successful PIN entry (unlock or setup)\n- Stored: In VaultContext state only (React state)\n- Destroyed: On vault lock (set to null, garbage collected)\n- Never persisted to any storage\n\n### Firebase Custom Claims\n```typescript\n{\n  vault_secret: string;    // 32-byte hex string (64 characters)\n}\n```\n\n**Generation:**\n- Created on first authentication via `/api/auth/init`\n- Generated using `crypto.randomBytes(32).toString('hex')`\n- Stored in Firebase as user custom claim\n- Immutable (never regenerated for same user)\n\n### API Request/Response Models\n\n#### POST `/api/auth/init`\n**Request:**\n```typescript\n{\n  idToken: string;         // Firebase ID token\n}\n```\n\n**Response:**\n```typescript\n{\n  status: 'ready' | 'created';\n}\n```\n\n#### POST `/api/scribe`\n**Request (multipart/form-data):**\n```typescript\n{\n  audio: File;             // Audio blob (audio/webm)\n  idToken: string;         // Firebase ID token\n}\n```\n\n**Response:**\n```typescript\n{\n  transcript: string;      // Raw transcript\n  soapNote: string;        // Formatted SOAP note\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n#### 1. Microphone Access Denied\n- **Handling:** Catch MediaDevices.getUserMedia rejection\n- **User Impact:** Display error message: \"Microphone access required. Please allow in browser settings.\"\n- **Recovery:** Show retry button that re-requests permission\n\n#### 2. Network Error During Upload\n- **Handling:** Implement retry logic with exponential backoff (3 attempts: 1s, 2s, 4s)\n- **User Impact:** Display status: \"Upload failed. Retrying...\"\n- **Recovery:** If all retries fail, show: \"Upload failed. Please check your connection and try again.\"\n\n#### 3. Groq API Error (Rate Limit, Service Down)\n- **Handling:** Catch API errors and preserve audio blob\n- **User Impact:** Display: \"AI processing failed. Please try again.\"\n- **Recovery:** Allow user to retry with same audio blob (don't require re-recording)\n\n#### 4. Decryption Failed\n- **Handling:** Catch decrypt errors on individual notes\n- **User Impact:** Display warning badge on note card: \"Could not decrypt note. Data may be corrupted.\"\n- **Recovery:** Offer \"Delete Corrupted Note\" button\n\n#### 5. Max PIN Attempts Exceeded\n- **Handling:** After 5th failed attempt, call `purgeAllData()` and `signOut()`\n- **User Impact:** Display: \"Too many incorrect PIN attempts. All local data has been erased for security.\"\n- **Recovery:** Redirect to login page, user starts fresh\n\n#### 6. Idle Timeout\n- **Handling:** Auto-lock vault after 15 minutes of inactivity (unless recording/processing)\n- **User Impact:** Display PIN overlay on next interaction\n- **Recovery:** User re-enters PIN to continue\n\n#### 7. Recording Auto-Stop (60 Minutes)\n- **Handling:** useEffect cleanup on duration reaching MAX_RECORDING_MS\n- **User Impact:** Toast notification: \"Recording reached 60-minute limit and has been stopped.\"\n- **Recovery:** Recording proceeds to transcription automatically\n\n#### 8. IndexedDB Quota Exceeded\n- **Handling:** Catch QuotaExceededError on save\n- **User Impact:** Display: \"Storage full. Please delete old notes.\"\n- **Recovery:** User deletes notes manually, or wait for 12-hour janitor cleanup\n\n#### 9. Firebase Token Expired\n- **Handling:** Refresh token on 401 responses\n- **User Impact:** Brief loading indicator during refresh\n- **Recovery:** Retry API call with fresh token\n\n#### 10. Browser Not Supported\n- **Handling:** Check for Web Crypto API and IndexedDB on mount\n- **User Impact:** Display: \"Your browser is not supported. Please use Chrome, Safari, Firefox, or Edge.\"\n- **Recovery:** None (user must switch browser)\n\n### Global Error Boundary\n- Wrap `_app.tsx` with React Error Boundary\n- Catch component rendering errors\n- Display fallback UI: \"Something went wrong. Please refresh the page.\"\n- Log error to console (no PHI in error messages)\n\n## Testing Strategy\n\n### Unit Testing\n\n**Framework:** Jest + React Testing Library\n\n**Key Components to Test:**\n\n1. **Crypto Utilities (`crypto.ts`)**\n   - Test key derivation produces consistent results with same inputs\n   - Test different PINs produce different keys\n   - Test encryption produces unique ciphertexts (different IVs)\n   - Test decryption recovers original plaintext\n   - Test wrong key fails decryption\n   - Test PIN validation regex\n\n2. **Storage Utilities (`storage.ts`)**\n   - Mock IndexedDB\n   - Test save/load/delete operations\n   - Test janitor deletes old notes\n   - Test purge clears all data\n\n3. **Hooks**\n   - `useRecorder`: Test state transitions (idle → recording → processing → complete)\n   - `useNotes`: Test CRUD operations\n   - `useIdleTimer`: Test timer reset on activity\n\n4. **Components**\n   - `PINOverlay`: Test PIN input validation, attempts counter\n   - `NoteCard`: Test expand/collapse, copy actions\n   - `Recorder`: Test button states based on recording status\n\n### Integration Testing\n\n**Framework:** Jest + React Testing Library + MSW (Mock Service Worker)\n\n**Key Flows to Test:**\n\n1. **Authentication Flow**\n   - Mock Firebase auth\n   - Test login → `/api/auth/init` → token refresh → redirect\n   - Test logout clears session\n\n2. **Recording Flow**\n   - Mock MediaRecorder API\n   - Mock `/api/scribe` endpoint\n   - Test record → upload → transcribe → encrypt → save\n   - Test error recovery (retry logic)\n\n3. **Vault Lock/Unlock Flow**\n   - Test correct PIN unlocks vault\n   - Test incorrect PIN decrements attempts\n   - Test 5 failed attempts triggers purge\n\n4. **Session Timeout Flow**\n   - Mock timers\n   - Test idle timeout locks vault\n   - Test recording prevents idle lock\n\n### End-to-End Testing\n\n**Framework:** Playwright\n\n**User Scenarios to Test:**\n\n1. **First-Time User Journey**\n   - Navigate to app → redirected to login\n   - Sign in with Google\n   - Create 6-digit PIN\n   - Record 10-second audio\n   - Verify SOAP note appears\n   - Copy SOAP note\n   - Delete note\n\n2. **Returning User Journey**\n   - Navigate to app → PIN overlay\n   - Enter correct PIN\n   - View existing notes\n   - Record new note\n   - Sign out\n\n3. **Security Scenarios**\n   - Enter wrong PIN 5 times → verify data purge\n   - Wait 15 minutes idle → verify vault locks\n   - Close browser → reopen → verify session cleared\n\n4. **Edge Cases**\n   - Record for 60 minutes → verify auto-stop\n   - Lose network during upload → verify retry\n   - Deny microphone access → verify error message\n\n### Manual Testing Checklist\n\n- [ ] Test on iOS Safari (Web Crypto API, MediaRecorder support)\n- [ ] Test on Android Chrome (MediaRecorder codecs)\n- [ ] Test on desktop browsers (Chrome, Firefox, Edge, Safari)\n- [ ] Test with VoiceOver (iOS) for accessibility\n- [ ] Test with screen reader (NVDA/JAWS) for accessibility\n- [ ] Test offline mode (recording should work, upload should queue)\n- [ ] Test low storage scenario (IndexedDB quota)\n- [ ] Verify no PHI in browser DevTools console\n- [ ] Verify no PHI in Network tab (check request/response headers)\n- [ ] Test 12-hour janitor (mock timestamps)\n\n## Performance Considerations\n\n### Client-Side Performance\n\n1. **Key Derivation Latency**\n   - PBKDF2 with 250k iterations takes 100-500ms\n   - Display loading spinner during unlock\n   - Consider Web Workers for non-blocking execution (future optimization)\n\n2. **Encryption/Decryption Throughput**\n   - AES-GCM is fast (~10MB/s in browser)\n   - SOAP notes are small (<10KB typically)\n   - Encryption overhead negligible\n\n3. **IndexedDB Performance**\n   - idb-keyval is async (non-blocking)\n   - Reading 100 notes takes ~50ms\n   - Use pagination if note count exceeds 1000 (unlikely given 12-hour TTL)\n\n4. **Audio Recording**\n   - MediaRecorder uses hardware encoding (efficient)\n   - 60-minute recording at 128kbps ≈ 60MB\n   - Blob creation is instant (no processing)\n\n### Network Performance\n\n1. **Audio Upload Size**\n   - 10-minute recording ≈ 10MB\n   - 60-minute recording ≈ 60MB\n   - Use compression if needed (Opus codec already efficient)\n\n2. **Groq API Latency**\n   - Whisper Turbo: ~5-10 seconds for 10-minute audio\n   - Llama 3.3 70B: ~3-5 seconds for 2000 tokens\n   - Total: ~10-15 seconds for full pipeline\n\n3. **Retry Strategy**\n   - Exponential backoff: 1s, 2s, 4s (3 attempts max)\n   - Timeout: 60 seconds per attempt\n\n### Optimization Strategies\n\n- **Lazy Load**: Load shadcn/ui components dynamically (Next.js automatic code splitting)\n- **Memoization**: Use React.memo for NoteCard components (prevent re-renders)\n- **Virtual Scrolling**: If note count > 100, implement virtual list (future optimization)\n- **Service Worker**: Cache app shell for offline support (future enhancement)\n\n## Security Considerations\n\n### Client-Side Security\n\n1. **Key Management**\n   - Vault key stored only in React state (volatile memory)\n   - Non-extractable flag prevents key export\n   - Key destroyed on vault lock (garbage collected)\n\n2. **PIN Security**\n   - PIN never stored (exists only as function parameter)\n   - Brute force protection (5 attempts max)\n   - Rate limiting via attempt counter\n\n3. **Data Encryption**\n   - AES-GCM authenticated encryption (prevents tampering)\n   - Unique IV per encryption (prevents pattern analysis)\n   - Strong key derivation (PBKDF2 250k iterations)\n\n4. **Session Security**\n   - browserSessionPersistence (token cleared on browser close)\n   - Idle timeout (15 minutes)\n   - Max recording time (60 minutes)\n\n### Server-Side Security\n\n1. **Token Verification**\n   - All API routes verify Firebase JWT\n   - Invalid tokens return 401 immediately\n   - No processing without valid authentication\n\n2. **Stateless Processing**\n   - Audio and transcripts never written to disk\n   - Data exists only in function memory during request\n   - Memory cleared on function completion (serverless)\n\n3. **Logging Restrictions**\n   - Never log PHI (transcripts, notes, patient data)\n   - Log only: user ID, timestamp, error type\n   - Production logs audited for compliance\n\n4. **HTTPS Enforcement**\n   - All traffic over TLS 1.3\n   - Strict-Transport-Security header\n   - Content-Security-Policy header\n\n### Compliance Measures\n\n1. **HIPAA BAA**\n   - Human signs BAAs with Firebase and Groq\n   - Document BAA signatures in compliance folder\n\n2. **Safe Harbor**\n   - Device theft → encrypted data useless without PIN\n   - Cloud compromise → no PHI stored on servers\n   - Account takeover → data encrypted with user-specific vault secret\n\n3. **Audit Trail**\n   - Log authentication events (user ID, timestamp)\n   - Log API calls (user ID, endpoint, timestamp, error code)\n   - Never log PHI content\n\n## Deployment Architecture\n\n### Next.js Build Configuration\n\n```javascript\n// next.config.js\nmodule.exports = {\n  output: 'standalone',\n  reactStrictMode: true,\n  compress: true,\n  poweredByHeader: false,\n\n  // Security headers\n  async headers() {\n    return [\n      {\n        source: '/:path*',\n        headers: [\n          {\n            key: 'X-Frame-Options',\n            value: 'DENY',\n          },\n          {\n            key: 'X-Content-Type-Options',\n            value: 'nosniff',\n          },\n          {\n            key: 'Strict-Transport-Security',\n            value: 'max-age=31536000; includeSubDomains',\n          },\n          {\n            key: 'Content-Security-Policy',\n            value: \"default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://api.groq.com;\",\n          },\n        ],\n      },\n    ];\n  },\n};\n```\n\n### Docker Configuration\n\n```dockerfile\nFROM node:20-alpine AS builder\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci\nCOPY . .\nRUN npm run build\n\nFROM node:20-alpine AS runner\nWORKDIR /app\nENV NODE_ENV=production\nCOPY --from=builder /app/.next/standalone ./\nCOPY --from=builder /app/.next/static ./.next/static\nCOPY --from=builder /app/public ./public\nEXPOSE 3000\nCMD [\"node\", \"server.js\"]\n```\n\n### Environment Variables (Production)\n\n- `NEXT_PUBLIC_FIREBASE_*`: Client-side Firebase config (public)\n- `FIREBASE_SERVICE_ACCOUNT_JSON`: Server-side Firebase credentials (secret)\n- `GROQ_API_KEY`: Groq API key (secret)\n- `NODE_ENV=production`: Enable production optimizations\n\n### Monitoring and Alerts\n\n- **Error Tracking**: Sentry (configure to exclude PHI from error reports)\n- **Performance Monitoring**: Next.js analytics\n- **Uptime Monitoring**: Pingdom or similar\n- **Log Aggregation**: Google Cloud Logging (with PHI filters)\n\n## Migration and Rollout Strategy\n\nSince this is a new application:\n\n1. **Development Phase**\n   - Local development with `.env.local`\n   - Test with Firebase emulator and mock Groq API\n\n2. **Staging Phase**\n   - Deploy to staging environment\n   - Test with real Firebase (staging project) and Groq (dev tier)\n   - Conduct security audit and penetration testing\n\n3. **Production Rollout**\n   - Deploy to production (Cloud Run)\n   - Pilot with 5-10 trusted users\n   - Collect feedback and iterate\n   - Gradual rollout to full user base\n\n4. **Post-Launch**\n   - Monitor error rates and performance metrics\n   - Collect user feedback on UX\n   - Iterate on features (WebAuthn, voice commands, etc.)\n",
  "fileStats": {
    "size": 29967,
    "lines": 933,
    "lastModified": "2026-01-09T04:23:50.130Z"
  },
  "comments": []
}